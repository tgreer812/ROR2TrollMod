@page "/"
@inject IRoR2ModService ModService

<PageTitle>RoR2 Troll Mod</PageTitle>

<div class="home-container">
    <h1>RoR2 Troll Mod Control Panel</h1>
    
    <div class="controls-section">
        <EnableToggle @bind-IsEnabled="isModEnabled" @bind-IsEnabled:after="HandleToggleChanged" />
        <PlayerDropdown @bind-SelectedPlayer="selectedPlayer" Players="players" />
    </div>

    <div class="item-cards-section">
        <h2>Item Cards</h2>
        <ItemCardsContainer Items="@items" IsLoading="@isLoading" />
    </div>
</div>

@code {
    private bool isModEnabled = false;
    private string selectedPlayer = "";
    private List<string> players = new List<string>();
    private List<Item> items = new List<Item>();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        await Task.WhenAll(LoadPlayers(), LoadItems());
        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadPlayers()
    {
        try
        {
            var playerList = await ModService.GetAllPlayersAsync();
            players = playerList.Select(p => p.Name).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load players: {ex.Message}");
            players = new List<string>();
        }
    }

    private async Task LoadItems()
    {
        try
        {
            items = await ModService.GetAllItemsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load items: {ex.Message}");
            items = new List<Item>();
        }
    }

    private async Task HandleToggleChanged()
    {
        try
        {
            ApiResponse result;
            if (isModEnabled)
            {
                Console.WriteLine("Enabling mod...");
                result = await ModService.EnableAsync();
            }
            else
            {
                Console.WriteLine("Disabling mod...");
                result = await ModService.DisableAsync();
            }

            if (!string.IsNullOrEmpty(result.Error))
            {
                Console.WriteLine($"Error toggling mod: {result.Error}");
            }
            else
            {
                Console.WriteLine($"Mod toggle result: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error handling toggle change: {ex.Message}");
        }
    }
}
